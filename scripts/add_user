#!/bin/bash

# Add new user account.

# Tested on:
# Ubuntu 12.04
# Ubuntu 14.04

# Usage:
# overcast run myInstanceOrCluster add_user --env "username=newuser"

# set -x

if [ "$(id -u)" != "0" ]; then
   echo "This script must be run as root." 1>&2
   exit 1
fi

if [ -z "$username" ]; then
  echo "No username defined."
  exit 1
fi

if [ -z "$password" ]; then
  password=`cat /dev/urandom | tr -dc 'a-zA-Z0-9' | fold -w 32 | head -n 1`
  echo Using autogenerated password:
  echo $password
fi

# Add user.

useradd -m -s /bin/bash -p $password $username

# Set up SSH access.

mkdir -p /home/$username/.ssh
cp /root/.ssh/authorized_keys /home/$username/.ssh/authorized_keys
chown -R $username:$username /home/$username/.ssh
chmod 600 /home/$username/.ssh/authorized_keys
chmod 700 /home/$username/.ssh

# Add sftp group if it doesn't already exist.

groupadd -f sftp

# Add user to the sftp group.

usermod -G sftp $username

echo "User $username created. Home directory is /home/$username."

exit 0
