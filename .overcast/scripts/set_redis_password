#!/bin/bash

# Configure Redis to use password authentication. If redisPassword is not set,
# an autogenerated 256-bit password will be returned by the script.
# Tested on Ubuntu 12.04.

# Usage:
# overcast run myInstanceOrCluster set_redis_password
# overcast run myInstanceOrCluster set_redis_password --env "redisPassword=myPredefinedPassword"

# set -x

if [ "$(id -u)" != "0" ]; then
  echo "This script must be run as root." 1>&2
  exit 1
fi

if [ -z "$redisPassword" ]; then
  redisPassword=`cat /dev/urandom | tr -dc 'a-zA-Z0-9' | fold -w 43 | head -n 1`
  echo "$redisPassword"
fi

sed -i "s/#\? \?requirepass .*/requirepass $redisPassword/g" /etc/redis/redis.conf

service redis-server restart
